"use strict";(()=>{var e={};e.id=4744,e.ids=[4744],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},6631:(e,t,r)=>{r.r(t),r.d(t,{config:()=>f,default:()=>g,routeModule:()=>p});var a={};r.r(a),r.d(a,{default:()=>d});var o=r(1802),s=r(7153),n=r(6249);let i=require("pdf-lib"),l=async(e,t)=>{try{let r=await i.PDFDocument.create(),a=r.addPage([612,792]),{width:o,height:s}=a.getSize(),n=await r.embedFont(i.StandardFonts.Helvetica),l=await r.embedFont(i.StandardFonts.HelveticaBold),c=e.form_data,u=s-50;if(a.drawText("NBCC MEMBERSHIP AGREEMENT",{x:50,y:u,size:20,font:l,color:(0,i.rgb)(0,0,0)}),u-=30,a.drawText(`Date: ${new Date().toLocaleDateString()}`,{x:50,y:u,size:12,font:n}),u-=40,a.drawText("PERSONAL INFORMATION",{x:50,y:u,size:14,font:l}),u-=25,[["Full Name:",c.fullName],["Email:",c.email],["Phone:",c.phone],["Date of Birth:",c.dateOfBirth],["Address:",c.address]].forEach(([e,t])=>{a.drawText(e,{x:50,y:u,size:10,font:l}),a.drawText(t||"Not provided",{x:150,y:u,size:10,font:n}),u-=20}),u-=20,a.drawText("EMERGENCY CONTACT",{x:50,y:u,size:14,font:l}),u-=25,[["Contact Name:",c.emergencyContact],["Contact Phone:",c.emergencyPhone]].forEach(([e,t])=>{a.drawText(e,{x:50,y:u,size:10,font:l}),a.drawText(t||"Not provided",{x:150,y:u,size:10,font:n}),u-=20}),u-=20,a.drawText("CHURCH BACKGROUND",{x:50,y:u,size:14,font:l}),u-=25,[["Previous Church:",c.previousChurch],["Baptized:",c.baptized]].forEach(([e,t])=>{a.drawText(e,{x:50,y:u,size:10,font:l}),a.drawText(t||"Not specified",{x:150,y:u,size:10,font:n}),u-=20}),c.testimony&&(u-=10,a.drawText("Testimony:",{x:50,y:u,size:10,font:l}),u-=15,(function(e,t,r,a){let o=e.split(" "),s=[],n="";return o.forEach(e=>{let t=n?`${n} ${e}`:e;500>=r.widthOfTextAtSize(t,10)?n=t:n?(s.push(n),n=e):s.push(e)}),n&&s.push(n),s})(c.testimony,0,n,0).forEach(e=>{a.drawText(e,{x:50,y:u,size:10,font:n}),u-=15})),u-=30,a.drawText("MEMBERSHIP AGREEMENT",{x:50,y:u,size:14,font:l}),u-=25,["I hereby request membership in this church and agree to:","• Support the church with my prayers, presence, gifts, and service","• Live according to Christian principles and church teachings","• Participate actively in the life and ministry of the church","• Submit to the spiritual authority of the church leadership","","I confirm that all information provided above is accurate and complete."].forEach(e=>{a.drawText(e,{x:50,y:u,size:10,font:n}),u-=15}),u-=30,a.drawText("SIGNATURES",{x:50,y:u,size:14,font:l}),u-=40,e.user_signature)try{let t;if(console.log("Embedding user signature..."),e.user_signature.startsWith("data:")){let r=await fetch(e.user_signature);t=await r.arrayBuffer()}else{let r=await fetch(e.user_signature);if(!r.ok)throw Error(`Failed to fetch signature: ${r.status}`);t=await r.arrayBuffer()}let o=await r.embedPng(t);a.drawImage(o,{x:50,y:u-40,width:150,height:40}),console.log("User signature embedded successfully")}catch(e){console.error("Error embedding user signature:",e),a.drawText("[User Signature - Error Loading]",{x:50,y:u-20,size:10,font:n})}else a.drawText("[No User Signature]",{x:50,y:u-20,size:10,font:n});if(a.drawText("_________________________",{x:50,y:u-50,size:10,font:n}),a.drawText(`Member: ${c.fullName}`,{x:50,y:u-65,size:10,font:n}),a.drawText(`Date: ${new Date(e.created_at).toLocaleDateString()}`,{x:50,y:u-80,size:10,font:n}),t)try{let e;if(console.log("Embedding pastor signature..."),t.startsWith("data:")){let r=await fetch(t);e=await r.arrayBuffer()}else{let r=await fetch(t);if(!r.ok)throw Error(`Failed to fetch pastor signature: ${r.status}`);e=await r.arrayBuffer()}let o=await r.embedPng(e);a.drawImage(o,{x:320,y:u-40,width:150,height:40}),console.log("Pastor signature embedded successfully")}catch(e){console.error("Error embedding pastor signature:",e),a.drawText("[Pastor Signature - Error Loading]",{x:320,y:u-20,size:10,font:n})}else a.drawText("[No Pastor Signature]",{x:320,y:u-20,size:10,font:n});a.drawText("_________________________",{x:320,y:u-50,size:10,font:n}),a.drawText("Pastor/Church Leader",{x:320,y:u-65,size:10,font:n}),a.drawText(`Date: ${new Date().toLocaleDateString()}`,{x:320,y:u-80,size:10,font:n}),a.drawText("NBCC LMS - Church Membership Agreement",{x:50,y:30,size:8,font:n,color:(0,i.rgb)(.5,.5,.5)}),a.drawText(`Generated on ${new Date().toLocaleDateString()}`,{x:400,y:30,size:8,font:n,color:(0,i.rgb)(.5,.5,.5)});let d=await r.save();return new Blob([d],{type:"application/pdf"})}catch(e){throw console.error("Error generating PDF:",e),Error("Failed to generate PDF: "+e.message)}};var c=r(8471),u=r(8456);async function d(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let{agreementId:r,pastorSignature:a}=e.body;if(!r||!a)return t.status(400).json({error:"Agreement ID and pastor signature are required"});console.log("Starting agreement approval process for:",r);let{data:o,error:s}=await u.OQ.from("agreements").select("*").eq("id",r).single();if(s||!o)return console.error("Error fetching agreement:",s),t.status(404).json({error:"Agreement not found"});console.log("Agreement found, generating PDF...");let n=await l(o,a);console.log("PDF generated successfully, size:",n.size);let i=`agreement-${o.id}-${Date.now()}.pdf`;console.log("Uploading PDF with filename:",i);let d=await (0,c.k)(i,n);if(!d.success)return console.error("Upload failed:",d.error),t.status(500).json({error:`Upload failed: ${d.error}`});console.log("PDF uploaded successfully:",d.publicUrl),console.log("Updating agreement in database...");let{error:g}=await u.OQ.from("agreements").update({pastor_signature:a,pdf_url:d.publicUrl,status:"completed",signed_at:new Date().toISOString()}).eq("id",o.id);if(g)return console.error("Database update error:",g),t.status(500).json({error:`Database update failed: ${g.message}`});return console.log("Agreement updated in database successfully"),console.log("=== EMAIL WILL BE SENT BY CLIENT-SIDE ==="),console.log("User email:",o.form_data?.email),console.log("User name:",o.form_data?.fullName),console.log("PDF URL:",d.publicUrl),t.status(200).json({success:!0,message:"Agreement approved and PDF generated successfully",pdfUrl:d.publicUrl})}catch(e){return console.error("Error approving agreement:",e),t.status(500).json({error:`Failed to approve agreement: ${e.message}`})}}let g=(0,n.l)(a,"default"),f=(0,n.l)(a,"config"),p=new o.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/admin/approve-agreement",pathname:"/api/admin/approve-agreement",bundlePath:"",filename:""},userland:a})},8471:(e,t,r)=>{r.d(t,{I:()=>s,k:()=>n});var a=r(2885);let o=()=>{if(!process.env.SUPABASE_SERVICE_ROLE_KEY)throw Error("Missing Supabase configuration for storage setup");return(0,a.createClient)("https://qyhdzjzvkggcsuhnenaz.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY)},s=async()=>{try{console.log("Checking storage buckets...");let e=o(),{data:t,error:r}=await e.storage.listBuckets();if(r)throw console.error("Error listing buckets:",r),r;if(console.log("Existing buckets:",t?.map(e=>e.name)),t?.some(e=>"agreements"===e.name))console.log("Agreements bucket already exists");else{console.log("Creating agreements bucket...");let{data:t,error:r}=await e.storage.createBucket("agreements",{public:!0,fileSizeLimit:10485760,allowedMimeTypes:["application/pdf"]});if(r)throw console.error("Error creating agreements bucket:",r),r;console.log("Agreements bucket created successfully:",t)}return{success:!0}}catch(e){return console.error("Storage setup error:",e),{success:!1,error:e}}},n=async(e,t)=>{try{console.log("Uploading PDF:",e);let r=o();await s();let{data:a,error:n}=await r.storage.from("agreements").upload(e,t,{contentType:"application/pdf",upsert:!0});if(n)throw console.error("Upload error:",n),n;console.log("Upload successful:",a);let{data:i}=r.storage.from("agreements").getPublicUrl(e);return console.log("Public URL:",i.publicUrl),{success:!0,path:a.path,publicUrl:i.publicUrl}}catch(e){return console.error("PDF upload error:",e),{success:!1,error:e.message}}}},8456:(e,t,r)=>{r.d(t,{OQ:()=>n});var a=r(2885);let o="https://qyhdzjzvkggcsuhnenaz.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5aGR6anp2a2dnY3N1aG5lbmF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0NjY1NzgsImV4cCI6MjA2NTA0MjU3OH0.wauN1JdrKCl82WFuwtCfq0oZVob8UEE71wjJw6otCFY";console.log("\uD83D\uDD0D Supabase Debug Info:"),console.log("URL:",o),console.log("Key exists:",!!s),console.log("Key length:",s?.length),console.log("✅ Is Supabase configured:",!!(o&&s&&o.includes("supabase.co")&&s.length>50));let n=o&&s?(0,a.createClient)(o,s):null;console.log("\uD83D\uDE80 Supabase client created:",!!n)},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=6631);module.exports=r})();