"use strict";(()=>{var e={};e.id=454,e.ids=[454],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6201:e=>{e.exports=import("react-hot-toast")},6249:(e,o)=>{Object.defineProperty(o,"l",{enumerable:!0,get:function(){return function e(o,t){return t in o?o[t]:"then"in o&&"function"==typeof o.then?o.then(o=>e(o,t)):"function"==typeof o&&"default"===t?o:void 0}}})},7939:(e,o,t)=>{t.r(o),t.d(o,{config:()=>g,default:()=>u,routeModule:()=>p});var s={};t.r(s),t.d(s,{default:()=>d});var n=t(1802),r=t(7153),a=t(6249),i=t(2885),l=t(8915);let c=(0,i.createClient)("https://qyhdzjzvkggcsuhnenaz.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function d(e,o){if(o.setHeader("Content-Type","application/json"),"POST"!==e.method)return o.status(405).json({error:"Method not allowed"});try{console.log("Upload sections API called"),console.log("Request headers:",e.headers);let{user:t,error:s}=await (0,l.su)(e);if(s||!t)return console.log("Authentication failed:",s),o.status(401).json({error:s||"Unauthorized"});console.log("Admin authenticated:",t.email);let{sections:n}=e.body;if(!n||!Array.isArray(n))return console.log("Invalid sections data:",n),o.status(400).json({error:"Invalid sections data"});console.log("Processing",n.length,"sections"),console.log("Clearing existing sections...");let{error:r}=await c.from("pdf_sections").delete().neq("id","00000000-0000-0000-0000-000000000000");if(r)return console.error("Error deleting existing sections:",r),o.status(500).json({error:"Failed to clear existing sections",details:r.message});let a=[];for(let e=0;e<n.length;e++){let t=n[e];console.log(`Processing section ${e+1}/${n.length}:`,t.title);try{let e=new Uint8Array(t.content),s=`section-${t.section_number}-${Date.now()}.pdf`;console.log(`Uploading file: ${s}, size: ${e.length} bytes`);let{data:n,error:r}=await c.storage.from("pdf-sections").upload(s,e,{contentType:"application/pdf"});if(r)return console.error("Error uploading file:",r),o.status(500).json({error:`Failed to upload section ${t.section_number}`,details:r.message});console.log("File uploaded successfully:",n.path),a.push({title:t.title,section_number:t.section_number,total_sections:t.total_sections,file_path:n.path})}catch(e){return console.error(`Error processing section ${t.section_number}:`,e),o.status(500).json({error:`Failed to process section ${t.section_number}`,details:e.message})}}console.log("Inserting sections into database...");let{data:i,error:d}=await c.from("pdf_sections").insert(a).select();if(d)return console.error("Error inserting sections:",d),o.status(500).json({error:"Failed to insert sections",details:d.message});console.log("Upload completed successfully:",i.length,"sections"),o.status(200).json({sections:i})}catch(e){console.error("Upload sections error:",e),o.status(500).json({error:"Internal server error",details:e.message,stack:void 0})}}let u=(0,a.l)(s,"default"),g=(0,a.l)(s,"config"),p=new n.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/admin/upload-sections",pathname:"/api/admin/upload-sections",bundlePath:"",filename:""},userland:s})},8915:(e,o,t)=>{t.d(o,{Cn:()=>r,su:()=>a});var s=t(8456);let n=["admin@nbcc.com","pastor@nbcc.com","mppaul1458@gmail.com"],r=async(e,o)=>{try{let{data:t,error:r}=await s.OQ.from("users").select("is_admin, role").eq("id",e).single();if(!r&&t&&(!0===t.is_admin||"admin"===t.role))return!0;let a=n.includes(o.toLowerCase())||o.toLowerCase().includes("admin")||o.toLowerCase().includes("pastor");if(a&&e)try{await s.OQ.from("users").upsert({id:e,email:o,is_admin:!0,role:"admin"},{onConflict:"id",ignoreDuplicates:!1}),console.log("Updated admin status in database for:",o)}catch(e){console.warn("Could not update admin status in database:",e.message)}return a}catch(e){return console.warn("Admin status check failed:",e.message),n.includes(o.toLowerCase())||o.toLowerCase().includes("admin")||o.toLowerCase().includes("pastor")}},a=async e=>{try{console.log("Checking admin access for API route");let o=e.headers.authorization;if(console.log("Auth header present:",!!o),!o||!o.startsWith("Bearer "))return console.log("No valid authorization header found"),{user:null,error:"No authorization token provided"};let s=o.split(" ")[1];console.log("Token extracted, length:",s?.length);let{createClient:n}=await Promise.resolve().then(t.t.bind(t,2885,23)),a=n("https://qyhdzjzvkggcsuhnenaz.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);console.log("Verifying JWT token...");let{data:{user:i},error:l}=await a.auth.getUser(s);if(l)return console.log("Token verification failed:",l.message),{user:null,error:`Invalid or expired token: ${l.message}`};if(!i)return console.log("No user found from token"),{user:null,error:"Invalid or expired token"};console.log("User verified:",i.email);let c=await r(i.id,i.email);if(console.log("Admin status:",c),!c)return console.log("User does not have admin privileges"),{user:null,error:"Admin privileges required"};return console.log("Admin access granted"),{user:i,error:null}}catch(e){return console.error("API admin access check failed:",e),{user:null,error:`Authentication failed: ${e.message}`}}}},8456:(e,o,t)=>{t.d(o,{OQ:()=>a});var s=t(2885);let n="https://qyhdzjzvkggcsuhnenaz.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5aGR6anp2a2dnY3N1aG5lbmF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0NjY1NzgsImV4cCI6MjA2NTA0MjU3OH0.wauN1JdrKCl82WFuwtCfq0oZVob8UEE71wjJw6otCFY";console.log("\uD83D\uDD0D Supabase Debug Info:"),console.log("URL:",n),console.log("Key exists:",!!r),console.log("Key length:",r?.length),console.log("âœ… Is Supabase configured:",!!(n&&r&&n.includes("supabase.co")&&r.length>50));let a=n&&r?(0,s.createClient)(n,r):null;console.log("\uD83D\uDE80 Supabase client created:",!!a)},7153:(e,o)=>{var t;Object.defineProperty(o,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,o,t)=>{e.exports=t(145)}};var o=require("../../../webpack-api-runtime.js");o.C(e);var t=o(o.s=7939);module.exports=t})();