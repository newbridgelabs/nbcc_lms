(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7785],{5090:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/preview/[id]",function(){return r(3280)}])},5747:function(e,t,r){"use strict";r.d(t,{Z:function(){return i}});var s=r(5893),n=r(7294),l=r(4976),o=r(1707),a=r(2779);function i(e){let{pdfUrl:t,title:r}=e,[i,c]=(0,n.useState)(!0),[d,u]=(0,n.useState)(null),[h,m]=(0,n.useState)(0);(0,n.useEffect)(()=>{console.log("IframePDFViewer - PDF URL:",t),t&&(c(!0),u(null),m(e=>e+1))},[t]);let x=()=>{c(!0),u(null),m(e=>e+1)};return t?(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:[(0,s.jsx)("div",{className:"bg-gray-50 border-b border-gray-200 p-3 sm:p-4",children:(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-0",children:[(0,s.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,s.jsx)("h3",{className:"text-base sm:text-lg font-semibold text-gray-900 truncate",children:r}),(0,s.jsx)("p",{className:"text-xs sm:text-sm text-gray-600",children:"PDF Document"})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-2 flex-shrink-0",children:[(0,s.jsx)("button",{onClick:x,className:"p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded min-h-[44px] min-w-[44px] flex items-center justify-center",title:"Refresh PDF",children:(0,s.jsx)(l.Z,{className:"h-4 w-4"})}),(0,s.jsxs)("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"flex items-center px-2 sm:px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs sm:text-sm min-h-[44px]",children:[(0,s.jsx)(o.Z,{className:"h-4 w-4 sm:mr-2"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Open in New Tab"})]}),(0,s.jsxs)("a",{href:t,download:!0,className:"flex items-center px-2 sm:px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-xs sm:text-sm min-h-[44px]",children:[(0,s.jsx)(a.Z,{className:"h-4 w-4 sm:mr-2"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Download"})]})]})]})}),i&&(0,s.jsx)("div",{className:"flex items-center justify-center h-96 bg-gray-50",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"loading-spinner mx-auto mb-4"}),(0,s.jsx)("p",{className:"text-gray-600",children:"Loading PDF document..."}),(0,s.jsxs)("p",{className:"text-xs text-gray-500 mt-2",children:["URL: ",t]})]})}),d&&(0,s.jsxs)("div",{className:"bg-red-50 border border-red-200 p-6 text-center",children:[(0,s.jsx)("p",{className:"text-red-600 mb-4",children:d}),(0,s.jsx)("div",{className:"space-y-4",children:(0,s.jsxs)("div",{className:"flex justify-center space-x-4",children:[(0,s.jsx)("button",{onClick:x,className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Try Again"}),(0,s.jsx)("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Open PDF Directly"})]})})]}),(0,s.jsxs)("div",{className:"relative pdf-viewer-container",children:[(0,s.jsx)("iframe",{src:t,width:"100%",height:"800",className:"border-0 ".concat(i?"opacity-0":"opacity-100"," transition-opacity duration-300 w-full"),title:r||"PDF Document",onLoad:()=>{console.log("IframePDFViewer - PDF loaded successfully"),c(!1),u(null)},onError:()=>{console.error("IframePDFViewer - Error loading PDF in iframe"),u("Failed to load PDF in iframe"),c(!1)},style:{minHeight:"60vh",height:"clamp(400px, 60vh, 800px)"}},h),i&&(0,s.jsx)("div",{className:"absolute inset-0 bg-gray-50 flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center p-4",children:[(0,s.jsx)("div",{className:"loading-spinner mx-auto mb-4"}),(0,s.jsx)("p",{className:"text-gray-600 text-sm sm:text-base",children:"Loading PDF..."})]})})]}),(0,s.jsx)("div",{className:"bg-gray-50 border-t border-gray-200 p-3",children:(0,s.jsxs)("p",{className:"text-xs text-gray-500 truncate",children:["Source: ",t]})})]}):(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-8 text-center",children:(0,s.jsx)("p",{className:"text-gray-500",children:"No PDF URL provided"})})}},7298:function(e,t,r){"use strict";r.d(t,{KO:function(){return a},L$:function(){return c},oN:function(){return l},sN:function(){return n},t7:function(){return o},zy:function(){return i}});var s=r(9495);let n=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;try{let r=await e.arrayBuffer(),n=await s.PDFDocument.load(r),l=n.getPageCount(),o=Math.ceil(l/t),a=[];for(let e=0;e<t;e++){let t=e*o,r=Math.min(t+o-1,l-1);if(t<l){let l=await s.PDFDocument.create();for(let e=t;e<=r;e++){let[t]=await l.copyPages(n,[e]);l.addPage(t)}let o=await l.save();a.push({sectionNumber:e+1,title:"Section ".concat(e+1," (Pages ").concat(t+1,"-").concat(r+1,")"),content:o,pageRange:"".concat(t+1,"-").concat(r+1),totalPages:r-t+1})}}return{sections:a,error:null}}catch(e){return console.error("Error splitting PDF:",e),{sections:null,error:e}}},l=async(e,t)=>{try{console.log("Starting PDF sections upload...");let{data:{session:r}}=await t.auth.getSession();if(!(null==r?void 0:r.access_token))throw Error("No authentication token available");console.log("Session token available, preparing upload...");let s={sections:e.map(t=>({title:t.title,section_number:t.sectionNumber,total_sections:e.length,content:Array.from(new Uint8Array(t.content))}))};console.log("Sending request to upload API...");let n=await fetch("/api/admin/upload-sections",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r.access_token)},body:JSON.stringify(s)});if(console.log("Upload API response status:",n.status),!n.ok){let e="Failed to upload sections";try{let t=await n.json();e=t.error||e,console.error("Upload API error:",t)}catch(r){let t=await n.text();console.error("Upload API returned non-JSON response:",t),e=t.includes("<html>")||t.includes("<!DOCTYPE")?"Server returned HTML instead of JSON. Check server logs for authentication issues.":"Server error: ".concat(n.status," ").concat(n.statusText)}throw Error(e)}let l=await n.json();return console.log("Upload successful:",l),{sections:l.sections,error:null}}catch(e){return console.error("Error uploading sections:",e),{sections:null,error:e}}},o=async e=>{try{if(!e)return{sections:[],error:null};let{data:t,error:r}=await e.from("pdf_sections").select("*").order("section_number");if(r)throw r;return{sections:t,error:null}}catch(e){return{sections:null,error:e}}},a=async(e,t)=>{try{if(console.log("Getting PDF URL for file path:",e),!e)return console.error("No file path provided"),null;let{data:r}=t.storage.from("pdf-sections").getPublicUrl(e);if(console.log("Generated public URL:",null==r?void 0:r.publicUrl),null==r?void 0:r.publicUrl)return console.log("Returning public URL:",r.publicUrl),r.publicUrl;return null}catch(e){return console.error("Error getting PDF URL:",e),null}},i=async(e,t,r)=>{try{if(console.log("Marking section complete:",{userId:e,sectionId:t}),!e||!t)throw Error("User ID and Section ID are required");let r=await fetch("/api/complete-section",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,sectionId:t})}),s=await r.json();if(!r.ok)throw Error(s.error||"Failed to complete section");return console.log("Section marked complete successfully:",s.data),{data:s.data,error:null}}catch(e){return console.error("Error marking section complete:",e),{data:null,error:e}}},c=async(e,t)=>{try{if(!t||!e)return{progress:[],error:null};console.log("Getting user progress for userId:",e);let{data:r,error:s}=await t.from("user_progress").select("\n        *,\n        pdf_sections (\n          id,\n          title,\n          section_number,\n          total_sections\n        )\n      ").eq("user_id",e);if(s)throw console.error("Error fetching user progress:",s),s;console.log("Raw progress data:",r);let n=(null==r?void 0:r.filter(e=>null!==e.pdf_sections))||[];return console.log("Valid progress data:",n),{progress:n,error:null}}catch(e){return console.error("getUserProgress error:",e),{progress:null,error:e}}}},3765:function(e,t,r){"use strict";r.d(t,{Z:function(){return s}});let s=(0,r(3759).Z)("AlertCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]])},2761:function(e,t,r){"use strict";r.d(t,{Z:function(){return s}});let s=(0,r(3759).Z)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},2779:function(e,t,r){"use strict";r.d(t,{Z:function(){return s}});let s=(0,r(3759).Z)("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]])},5928:function(e,t,r){"use strict";r.d(t,{Z:function(){return s}});let s=(0,r(3759).Z)("Eye",[["path",{d:"M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z",key:"rwhkz3"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]])},4976:function(e,t,r){"use strict";r.d(t,{Z:function(){return s}});let s=(0,r(3759).Z)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]])},3280:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return p}});var s=r(5893),n=r(7294),l=r(1163),o=r(4733),a=r(5747),i=r(1046),c=r(1164),d=r(7298),u=r(2761),h=r(5928),m=r(3765),x=r(6501);function p(){let[e,t]=(0,n.useState)(null),[r,p]=(0,n.useState)(!0),[f,g]=(0,n.useState)(null),[y,v]=(0,n.useState)(null),w=(0,l.useRouter)(),{id:j}=w.query;(0,n.useEffect)(()=>{j&&N()},[j]);let N=async()=>{let{isAdmin:e,user:r}=await (0,c.jW)(w,t,p);e&&r&&await b()},b=async()=>{try{let{sections:e,error:t}=await (0,d.t7)(i.OQ);if(t)throw t;let r=parseInt(j),s=null==e?void 0:e.find(e=>e.section_number===r);if(!s){x.default.error("Section not found"),w.push("/admin/upload");return}if(g(s),s.file_path){console.log("Admin preview - Section found:",s),console.log("Admin preview - File path:",s.file_path);let e=await (0,d.KO)(s.file_path,i.OQ);console.log("Admin preview - Generated URL:",e),v(e)}else console.log("Admin preview - No file_path found for section:",s)}catch(e){console.error("Error loading section for admin preview:",e),x.default.error("Failed to load section")}finally{p(!1)}};return r?(0,s.jsx)(o.Z,{children:(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,s.jsx)("div",{className:"loading-spinner"})})}):f?(0,s.jsx)(o.Z,{children:(0,s.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,s.jsx)("div",{className:"bg-white shadow",children:(0,s.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:(0,s.jsx)("div",{className:"flex items-center justify-between",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("button",{onClick:()=>w.push("/admin/upload"),className:"mr-4 p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100",children:(0,s.jsx)(u.Z,{className:"h-5 w-5"})}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)(h.Z,{className:"h-6 w-6 text-church-primary mr-2"}),(0,s.jsxs)("h1",{className:"text-2xl font-bold text-gray-900",children:["Admin Preview: ",f.title]})]}),(0,s.jsxs)("p",{className:"mt-1 text-sm text-gray-500",children:["Section ",f.section_number," of ",f.total_sections," â€¢ Admin View"]})]})]})})})}),(0,s.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:(0,s.jsx)("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden",children:y?(0,s.jsx)(a.Z,{pdfUrl:y,title:f.title}):(0,s.jsxs)("div",{className:"p-8 text-center",children:[(0,s.jsxs)("div",{className:"text-red-600 mb-4",children:[(0,s.jsx)(m.Z,{className:"h-12 w-12 mx-auto mb-4"}),(0,s.jsx)("h3",{className:"text-lg font-medium",children:"PDF Not Available"}),(0,s.jsx)("p",{className:"text-sm text-gray-500 mt-2",children:"The PDF file could not be loaded. Please check if the file was uploaded correctly."})]}),(0,s.jsx)("div",{className:"mt-6",children:(0,s.jsx)("button",{onClick:()=>w.push("/admin/upload"),className:"px-4 py-2 bg-church-primary text-white rounded-md hover:bg-church-secondary",children:"Back to Upload"})})]})})})]})}):(0,s.jsx)(o.Z,{children:(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Section Not Found"}),(0,s.jsx)("button",{onClick:()=>w.push("/admin/upload"),className:"px-4 py-2 bg-church-primary text-white rounded-md hover:bg-church-secondary",children:"Back to Upload"})]})})})}}},function(e){e.O(0,[5285,9495,4733,2888,9774,179],function(){return e(e.s=5090)}),_N_E=e.O()}]);