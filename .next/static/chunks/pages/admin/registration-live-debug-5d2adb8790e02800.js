(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[117],{6610:function(e,s,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/registration-live-debug",function(){return t(4641)}])},7828:function(e,s,t){"use strict";t.d(s,{a$:function(){return a},qj:function(){return n},w2:function(){return i}});var r=t(1046);let a=async(e,s,t,a)=>{try{if(!r.OQ)throw Error("Supabase not configured. Please set up your environment variables in .env.local");let{data:o,error:d}=await r.OQ.rpc("check_allowed_user",{user_email:e.toLowerCase()});if(d)throw console.error("Error checking allowed user:",d),Error("Registration is by invitation only. Please contact church administration to be added to the allowed users list.");if(!o||0===o.length)throw Error("Registration is by invitation only. Please contact church administration to be added to the allowed users list.");if(o[0].is_used)throw Error("This invitation has already been used. Please try signing in instead.");console.log("Attempting Supabase registration for:",e);let{data:c,error:u}=await r.OQ.auth.signUp({email:e,password:s,options:{data:{full_name:t,username:a},emailRedirectTo:"".concat(window.location.origin,"/auth/callback")}});if(u){var i,n;if(console.error("Supabase registration error:",u),(null===(i=u.message)||void 0===i?void 0:i.includes("email"))&&(null===(n=u.message)||void 0===n?void 0:n.includes("confirm")))console.warn("Email confirmation not configured, proceeding with registration");else throw u}if((null==c?void 0:c.user)&&console.log("Supabase registration successful:",{userId:c.user.id,email:c.user.email,emailConfirmed:c.user.email_confirmed_at?"Yes":"No",needsConfirmation:!c.user.email_confirmed_at}),c.user)try{await l(c.user.id,{email:e,full_name:t,username:a,is_verified:!1}),await r.OQ.rpc("mark_allowed_user_used",{user_email:e.toLowerCase()})}catch(e){console.warn("Could not create user profile in custom table:",e.message)}return{data:c,error:null}}catch(e){return{data:null,error:e}}},l=async(e,s)=>{let{data:t,error:a}=await r.OQ.from("users").insert([{id:e,...s}]).select().single();if(a)throw a;return t},i=async(e,s)=>{try{if(!r.OQ)throw Error("Supabase not configured. Please set up your environment variables in .env.local");let{data:l,error:i}=await r.OQ.auth.signInWithPassword({email:e,password:s});if(i){var t,a;if(null===(t=i.message)||void 0===t?void 0:t.includes("Invalid login credentials"))try{let{data:s}=await r.OQ.rpc("check_allowed_user",{user_email:e.toLowerCase()});if(s&&s.length>0)throw Error('You have been invited to join but need to register first. Please click "Sign Up" and create your account using this email address.');{let{data:s}=await r.OQ.rpc("check_all_allowed_users",{user_email:e.toLowerCase()});if(s&&s.length>0)throw Error('Invalid password. Please check your password or use "Forgot Password" to reset it.');throw Error("Access denied. Please contact church administration to be added to the allowed users list.")}}catch(e){throw Error("Invalid login credentials. Please check your email and password, or contact church administration if you need access.")}else if(null===(a=i.message)||void 0===a?void 0:a.includes("Email not confirmed"))throw Error("Please check your email and click the verification link before signing in.");else throw i}return{data:l,error:null}}catch(e){return{data:null,error:e}}},n=async()=>{try{if(console.log("\uD83D\uDD0D Google Sign-In Debug:"),console.log("Supabase client exists:",!!r.OQ),!r.OQ)throw console.error("❌ Supabase client is null"),Error("Supabase not configured. Please check your environment variables.");console.log("\uD83D\uDE80 Attempting Google OAuth...");let{data:e,error:s}=await r.OQ.auth.signInWithOAuth({provider:"google",options:{redirectTo:"".concat(window.location.origin,"/auth/callback")}});return console.log("\uD83D\uDCCA OAuth response:",{data:e,error:s}),{data:e,error:s}}catch(e){return console.error("❌ Google sign-in error:",e),{data:null,error:e}}}},9354:function(e,s,t){"use strict";t.d(s,{Z:function(){return r}});let r=(0,t(3759).Z)("Database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]])},5062:function(e,s,t){"use strict";t.d(s,{Z:function(){return r}});let r=(0,t(3759).Z)("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]])},4641:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return m}});var r=t(5893),a=t(7294),l=t(4733),i=t(1046),n=t(7828);let o=(0,t(3759).Z)("Bug",[["path",{d:"m8 2 1.88 1.88",key:"fmnt4t"}],["path",{d:"M14.12 3.88 16 2",key:"qol33r"}],["path",{d:"M9 7.13v-1a3.003 3.003 0 1 1 6 0v1",key:"d7y7pr"}],["path",{d:"M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6",key:"xs1cw7"}],["path",{d:"M12 20v-9",key:"1qisl0"}],["path",{d:"M6.53 9C4.6 8.8 3 7.1 3 5",key:"32zzws"}],["path",{d:"M6 13H2",key:"82j7cp"}],["path",{d:"M3 21c0-2.1 1.7-3.9 3.8-4",key:"4p0ekp"}],["path",{d:"M20.97 5c0 2.1-1.6 3.8-3.5 4",key:"18gb23"}],["path",{d:"M22 13h-4",key:"1jl80f"}],["path",{d:"M17.2 17c2.1.1 3.8 1.9 3.8 4",key:"k3fwyw"}]]);var d=t(5062),c=t(9354),u=t(6501);function m(){let[e,s]=(0,a.useState)(!1),[t,m]=(0,a.useState)(null),[h,g]=(0,a.useState)({email:"alenps76@gmail.com",password:"TestPassword123!",fullName:"Alen Pradeep",username:"alen_test"}),p=async()=>{s(!0),m(null);let e={steps:[],finalResult:null,error:null};try{console.log("=== LIVE REGISTRATION DEBUG ==="),e.steps.push({step:1,name:"Checking allowed_users table",status:"running"});let{data:s,error:a}=await i.OQ.from("allowed_users").select("*").eq("email",h.email.toLowerCase()).eq("is_used",!1).single();if(a||!s){e.steps[0].status="failed",e.steps[0].error=(null==a?void 0:a.message)||"User not found or already used",e.steps[0].details={allowedError:a,allowedUser:s};let{data:t,error:r}=await i.OQ.from("allowed_users").select("*").eq("email",h.email.toLowerCase()).single();e.steps[0].anyUser=t,e.steps[0].anyError=null==r?void 0:r.message}else e.steps[0].status="success",e.steps[0].details=s;e.steps.push({step:2,name:"Checking if user exists in auth",status:"running"});try{let{data:s,error:t}=await i.OQ.from("users").select("*").eq("email",h.email.toLowerCase()).single();s?(e.steps[1].status="failed",e.steps[1].error="User already exists in users table",e.steps[1].details=s):(e.steps[1].status="success",e.steps[1].details="No existing user found")}catch(s){e.steps[1].status="success",e.steps[1].details="No existing user found (expected)"}if("success"===e.steps[0].status){e.steps.push({step:3,name:"Attempting registration",status:"running"});try{let s=await (0,n.a$)(h.email,h.password,h.fullName,h.username);if(s.error)e.steps[2].status="failed",e.steps[2].error=s.error.message,e.steps[2].details=s;else{var t,r;if(e.steps[2].status="success",e.steps[2].details=s,null===(r=s.data)||void 0===r?void 0:null===(t=r.user)||void 0===t?void 0:t.id)try{await i.OQ.auth.admin.deleteUser(s.data.user.id),console.log("Cleaned up test user")}catch(e){console.warn("Could not clean up test user:",e)}}}catch(s){e.steps[2].status="failed",e.steps[2].error=s.message,e.steps[2].details=s}}else e.steps.push({step:3,name:"Registration skipped",status:"skipped",reason:"allowed_users check failed"});e.steps.push({step:4,name:"Final allowed_users state",status:"running"});let{data:l,error:o}=await i.OQ.from("allowed_users").select("*").eq("email",h.email.toLowerCase()).single();e.steps[3].status="success",e.steps[3].details={finalState:l,finalError:null==o?void 0:o.message},m(e)}catch(s){console.error("Debug error:",s),e.error=s.message,m(e)}finally{s(!1)}},x=async()=>{try{console.log("Fixing allowed user..."),await i.OQ.from("allowed_users").delete().eq("email",h.email.toLowerCase());let{data:e,error:s}=await i.OQ.from("allowed_users").insert({email:h.email.toLowerCase(),full_name:h.fullName,is_used:!1}).select();if(s)throw s;u.default.success("Fresh allowed_users entry created!"),console.log("Created fresh entry:",e)}catch(e){console.error("Fix error:",e),u.default.error("Fix failed: "+e.message)}},f=e=>{switch(e){case"success":return"✅";case"failed":return"❌";case"running":return"\uD83D\uDD04";case"skipped":return"⏭️";default:return"❓"}};return(0,r.jsx)(l.Z,{requireAuth:!0,children:(0,r.jsx)("div",{className:"min-h-screen bg-gray-50",children:(0,r.jsx)("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:(0,r.jsxs)("div",{className:"bg-white shadow rounded-lg",children:[(0,r.jsxs)("div",{className:"px-6 py-4 border-b border-gray-200",children:[(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)(o,{className:"h-6 w-6 text-red-600 mr-3"}),(0,r.jsx)("h1",{className:"text-xl font-semibold text-gray-900",children:"Live Registration Debug"})]}),(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Step-by-step registration process debugging"})]}),(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"Test Data"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),(0,r.jsx)("input",{type:"email",value:h.email,onChange:e=>g(s=>({...s,email:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Full Name"}),(0,r.jsx)("input",{type:"text",value:h.fullName,onChange:e=>g(s=>({...s,fullName:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),(0,r.jsx)("input",{type:"password",value:h.password,onChange:e=>g(s=>({...s,password:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Username"}),(0,r.jsx)("input",{type:"text",value:h.username,onChange:e=>g(s=>({...s,username:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]})]}),(0,r.jsxs)("div",{className:"mb-6 flex flex-wrap gap-4",children:[(0,r.jsx)("button",{onClick:p,disabled:e,className:"bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 disabled:opacity-50 flex items-center",children:e?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"loading-spinner w-4 h-4 mr-2"}),"Testing..."]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(d.Z,{className:"h-4 w-4 mr-2"}),"Run Live Registration Test"]})}),(0,r.jsxs)("button",{onClick:x,className:"bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 flex items-center",children:[(0,r.jsx)(c.Z,{className:"h-4 w-4 mr-2"}),"Fix Allowed User Entry"]})]}),t&&(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)("h2",{className:"text-lg font-medium text-gray-900",children:"Debug Results"}),(0,r.jsx)("div",{className:"space-y-4",children:t.steps.map(e=>(0,r.jsxs)("div",{className:"p-4 rounded-lg border ".concat("success"===e.status?"bg-green-50 border-green-200":"failed"===e.status?"bg-red-50 border-red-200":"running"===e.status?"bg-blue-50 border-blue-200":"bg-gray-50 border-gray-200"),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsxs)("h3",{className:"font-medium",children:[f(e.status)," Step ",e.step,": ",e.name]}),(0,r.jsx)("span",{className:"text-sm px-2 py-1 rounded ".concat("success"===e.status?"bg-green-100 text-green-800":"failed"===e.status?"bg-red-100 text-red-800":"running"===e.status?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"),children:e.status})]}),e.error&&(0,r.jsxs)("p",{className:"text-sm text-red-600 mb-2",children:[(0,r.jsx)("strong",{children:"Error:"})," ",e.error]}),e.reason&&(0,r.jsxs)("p",{className:"text-sm text-gray-600 mb-2",children:[(0,r.jsx)("strong",{children:"Reason:"})," ",e.reason]}),e.anyUser&&(0,r.jsxs)("div",{className:"mt-2",children:[(0,r.jsx)("p",{className:"text-sm font-medium text-yellow-700",children:"User exists but is marked as used:"}),(0,r.jsx)("pre",{className:"text-xs bg-white p-2 rounded mt-1 overflow-x-auto",children:JSON.stringify(e.anyUser,null,2)})]}),e.details&&(0,r.jsxs)("details",{className:"mt-2",children:[(0,r.jsx)("summary",{className:"text-sm text-gray-600 cursor-pointer",children:"View Details"}),(0,r.jsx)("pre",{className:"text-xs bg-white p-2 rounded mt-1 overflow-x-auto",children:JSON.stringify(e.details,null,2)})]})]},e.step))}),t.error&&(0,r.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[(0,r.jsx)("h3",{className:"font-medium text-red-800 mb-2",children:"Overall Error:"}),(0,r.jsx)("p",{className:"text-sm text-red-700",children:t.error})]})]}),(0,r.jsxs)("div",{className:"mt-8 border-t pt-6",children:[(0,r.jsx)("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"What This Tool Does"}),(0,r.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:(0,r.jsxs)("ol",{className:"list-decimal list-inside space-y-1 text-sm text-blue-700",children:[(0,r.jsx)("li",{children:"Checks if the email exists in allowed_users table with is_used=false"}),(0,r.jsx)("li",{children:"Checks if the user already exists in the auth system"}),(0,r.jsx)("li",{children:"Attempts the actual registration process"}),(0,r.jsx)("li",{children:"Shows the final state of the allowed_users entry"}),(0,r.jsx)("li",{children:"Cleans up any test user created during the process"})]})})]})]})]})})})})}}},function(e){e.O(0,[5285,4733,2888,9774,179],function(){return e(e.s=6610)}),_N_E=e.O()}]);