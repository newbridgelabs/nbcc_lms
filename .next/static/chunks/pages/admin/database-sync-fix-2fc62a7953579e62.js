(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3547],{2144:function(e,s,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/database-sync-fix",function(){return t(6034)}])},493:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(3759).Z)("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},9354:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(3759).Z)("Database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]])},4976:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(3759).Z)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]])},8267:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(3759).Z)("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]])},9475:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(3759).Z)("XCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]])},6034:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return x}});var a=t(5893),r=t(7294),l=t(4733),n=t(1046),i=t(9354),c=t(9200),o=t(4976),d=t(8267),u=t(493),m=t(9475),h=t(6501);function x(){let[e,s]=(0,r.useState)(!1),[t,x]=(0,r.useState)("alenps76@gmail.com"),[g,f]=(0,r.useState)(null),[p,w]=(0,r.useState)(!1),b=async()=>{s(!0),f(null);try{console.log("=== DATABASE SYNC CHECK ==="),console.log("Checking email:",t);let s={email:t.toLowerCase(),allowedUsers:null,customUsers:null,authUsers:null,syncIssues:[],canRegister:!1},{data:r,error:l}=await n.OQ.from("allowed_users").select("*").eq("email",t.toLowerCase()).single();l&&"PGRST116"!==l.code?s.syncIssues.push("Error checking allowed_users: ".concat(l.message)):s.allowedUsers=r||null;let{data:i,error:c}=await n.OQ.from("users").select("*").eq("email",t.toLowerCase()).single();c&&"PGRST116"!==c.code?s.syncIssues.push("Error checking users table: ".concat(c.message)):s.customUsers=i||null;let o=!1;try{var e,a;let{error:s}=await n.OQ.auth.signInWithPassword({email:t.toLowerCase(),password:"fake-password-for-testing-123"});((null==s?void 0:null===(e=s.message)||void 0===e?void 0:e.includes("Invalid login credentials"))||(null==s?void 0:null===(a=s.message)||void 0===a?void 0:a.includes("Invalid email or password")))&&(o=!0)}catch(e){console.log("Auth test error:",e)}s.authUsers=o,s.authUsers&&!s.customUsers&&s.syncIssues.push("User exists in auth.users but not in custom users table"),s.customUsers&&!s.authUsers&&s.syncIssues.push("User exists in custom users table but not in auth.users"),s.allowedUsers?s.allowedUsers.is_used&&s.authUsers&&s.syncIssues.push("User marked as used in allowed_users and exists in auth - cannot register again"):s.syncIssues.push("User not in allowed_users table"),s.canRegister=s.allowedUsers&&!s.allowedUsers.is_used&&!s.authUsers,f(s),console.log("Sync status:",s)}catch(e){console.error("Sync check error:",e),h.default.error("Failed to check database sync: "+e.message)}finally{s(!1)}},y=async()=>{if(!g){h.default.error("Please run sync check first");return}w(!0);try{console.log("=== FIXING DATABASE SYNC ===");let e=[];if(g.customUsers){e.push("Removing user from custom users table...");let{error:s}=await n.OQ.from("users").delete().eq("email",t.toLowerCase());if(s)throw Error("Failed to delete from users table: ".concat(s.message));e.push("✅ Removed from custom users table")}if(g.allowedUsers){if(g.allowedUsers.is_used){e.push("Resetting allowed_users status...");let{error:s}=await n.OQ.from("allowed_users").update({is_used:!1,reset_at:new Date().toISOString(),reset_reason:"Database sync fix"}).eq("email",t.toLowerCase());if(s)throw Error("Failed to reset allowed_users: ".concat(s.message));e.push("✅ Reset allowed_users status")}}else{e.push("Adding user to allowed_users...");let{error:s}=await n.OQ.from("allowed_users").insert({email:t.toLowerCase(),full_name:t.split("@")[0],invited_by:"admin",invitation_sent_at:new Date().toISOString(),is_used:!1});if(s)throw Error("Failed to add to allowed_users: ".concat(s.message));e.push("✅ Added to allowed_users")}if(g.authUsers){e.push("Cleaning up auth.users...");let s=await fetch("/api/admin/cleanup-auth-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t.toLowerCase()})}),a=await s.json();if(!s.ok)throw Error("Auth cleanup failed: ".concat(a.error));a.userFound?(e.push("✅ Deleted user from auth.users"),e.push("✅ Complete database cleanup successful")):e.push("✅ User was already clean in auth.users")}e.forEach(e=>{console.log(e),h.default.success(e,{duration:2e3})}),h.default.success("Database sync fix completed! User should now be able to register."),setTimeout(()=>{b()},1e3)}catch(e){console.error("Fix failed:",e),h.default.error("Fix failed: "+e.message)}finally{w(!1)}};return(0,a.jsx)(l.Z,{children:(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,a.jsxs)("div",{className:"max-w-4xl mx-auto px-4",children:[(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6 mb-6",children:[(0,a.jsxs)("h1",{className:"text-2xl font-bold mb-6 flex items-center",children:[(0,a.jsx)(i.Z,{className:"h-6 w-6 mr-2 text-blue-600"}),"Database Sync Fix Tool"]}),(0,a.jsx)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-6",children:(0,a.jsxs)("div",{className:"flex",children:[(0,a.jsx)(c.Z,{className:"h-5 w-5 text-yellow-400 mr-2 mt-0.5"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-yellow-800",children:"Database Sync Issue Detected"}),(0,a.jsx)("p",{className:"mt-1 text-sm text-yellow-700",children:"When users are deleted from admin panel, they might still exist in Supabase's auth.users table, preventing new registration and email confirmation."})]})]})}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"User Email to Check"}),(0,a.jsx)("input",{type:"email",value:t,onChange:e=>x(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter email to check"})]}),(0,a.jsx)("div",{className:"flex space-x-2",children:(0,a.jsx)("button",{onClick:b,disabled:e||!t,className:"flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center",children:e?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(o.Z,{className:"h-4 w-4 mr-2 animate-spin"}),"Checking..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(i.Z,{className:"h-4 w-4 mr-2"}),"Check Sync"]})})})]}),(0,a.jsxs)("div",{className:"bg-gray-50 p-4 rounded-md",children:[(0,a.jsx)("h3",{className:"font-medium text-gray-900 mb-2",children:"Quick Actions"}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("button",{onClick:y,disabled:!g||p,className:"w-full bg-green-600 text-white py-2 px-3 rounded-md hover:bg-green-700 text-sm disabled:opacity-50",children:p?"Fixing...":"Fix Database Sync"}),(0,a.jsx)("button",{onClick:()=>{let e="\nManual Auth Cleanup Instructions:\n\n1. Go to Supabase Dashboard: https://supabase.com/dashboard\n2. Select your project\n3. Navigate to: Authentication → Users\n4. Search for: ".concat(t,"\n5. If user exists, click the delete button (trash icon)\n6. Confirm deletion\n7. Come back and run the sync check again\n\nThis will completely remove the user from Supabase's authentication system, \nallowing them to register fresh with email confirmation.\n    ").trim();navigator.clipboard.writeText(e).then(()=>{h.default.success("Instructions copied to clipboard!")}).catch(()=>{h.default.error("Could not copy to clipboard")})},className:"w-full bg-orange-600 text-white py-2 px-3 rounded-md hover:bg-orange-700 text-sm",children:"Copy Manual Cleanup Instructions"})]})]})]})]}),g&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsxs)("h2",{className:"text-lg font-semibold mb-4",children:["Database Sync Status for ",g.email]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[(0,a.jsxs)("div",{className:"bg-gray-50 p-4 rounded-md",children:[(0,a.jsxs)("h3",{className:"font-medium text-gray-900 mb-2 flex items-center",children:[(0,a.jsx)(d.Z,{className:"h-4 w-4 mr-1"}),"Allowed Users"]}),(0,a.jsxs)("div",{className:"flex items-center",children:[g.allowedUsers?(0,a.jsx)(u.Z,{className:"h-5 w-5 text-green-500 mr-2"}):(0,a.jsx)(m.Z,{className:"h-5 w-5 text-red-500 mr-2"}),(0,a.jsx)("span",{className:"text-sm",children:g.allowedUsers?"Present (Used: ".concat(g.allowedUsers.is_used?"Yes":"No",")"):"Not found"})]})]}),(0,a.jsxs)("div",{className:"bg-gray-50 p-4 rounded-md",children:[(0,a.jsxs)("h3",{className:"font-medium text-gray-900 mb-2 flex items-center",children:[(0,a.jsx)(i.Z,{className:"h-4 w-4 mr-1"}),"Custom Users"]}),(0,a.jsxs)("div",{className:"flex items-center",children:[g.customUsers?(0,a.jsx)(u.Z,{className:"h-5 w-5 text-green-500 mr-2"}):(0,a.jsx)(m.Z,{className:"h-5 w-5 text-red-500 mr-2"}),(0,a.jsx)("span",{className:"text-sm",children:g.customUsers?"Present":"Not found"})]})]}),(0,a.jsxs)("div",{className:"bg-gray-50 p-4 rounded-md",children:[(0,a.jsxs)("h3",{className:"font-medium text-gray-900 mb-2 flex items-center",children:[(0,a.jsx)(d.Z,{className:"h-4 w-4 mr-1"}),"Auth Users"]}),(0,a.jsxs)("div",{className:"flex items-center",children:[g.authUsers?(0,a.jsx)(c.Z,{className:"h-5 w-5 text-yellow-500 mr-2"}):(0,a.jsx)(u.Z,{className:"h-5 w-5 text-green-500 mr-2"}),(0,a.jsx)("span",{className:"text-sm",children:g.authUsers?"Present (ISSUE!)":"Not found (Good)"})]})]})]}),g.syncIssues.length>0&&(0,a.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-md p-4 mb-4",children:[(0,a.jsx)("h3",{className:"font-medium text-red-900 mb-2",children:"Sync Issues Found:"}),(0,a.jsx)("ul",{className:"list-disc list-inside space-y-1 text-red-800 text-sm",children:g.syncIssues.map((e,s)=>(0,a.jsx)("li",{children:e},s))})]}),(0,a.jsxs)("div",{className:"p-4 rounded-md ".concat(g.canRegister?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:[(0,a.jsx)("h3",{className:"font-medium mb-2 ".concat(g.canRegister?"text-green-900":"text-red-900"),children:"Registration Status:"}),(0,a.jsx)("p",{className:"text-sm ".concat(g.canRegister?"text-green-800":"text-red-800"),children:g.canRegister?"✅ User can register and receive email confirmation":"❌ User cannot register due to sync issues"})]})]})]})})})}}},function(e){e.O(0,[5285,4733,2888,9774,179],function(){return e(e.s=2144)}),_N_E=e.O()}]);