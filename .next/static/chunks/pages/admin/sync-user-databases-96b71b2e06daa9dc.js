(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9994],{949:function(e,s,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/sync-user-databases",function(){return r(7484)}])},493:function(e,s,r){"use strict";r.d(s,{Z:function(){return l}});let l=(0,r(3759).Z)("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},9354:function(e,s,r){"use strict";r.d(s,{Z:function(){return l}});let l=(0,r(3759).Z)("Database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]])},4976:function(e,s,r){"use strict";r.d(s,{Z:function(){return l}});let l=(0,r(3759).Z)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]])},7484:function(e,s,r){"use strict";r.r(s),r.d(s,{default:function(){return m}});var l=r(5893),t=r(7294),a=r(4733),n=r(1046),d=r(9354),i=r(9200),c=r(4976),o=r(493),h=r(6501);function m(){let[e,s]=(0,t.useState)(!1),[r,m]=(0,t.useState)(null),x=async()=>{s(!0),m(null);let e={orphanedAllowedUsers:[],activeUsers:[],resetCount:0,errors:[]};try{console.log("=== SYNCING USER DATABASES ===");let{data:s,error:r}=await n.OQ.from("users").select("id, email");r?e.errors.push("Failed to get active users: ".concat(r.message)):(e.activeUsers=s||[],console.log("Active users:",s));let{data:l,error:t}=await n.OQ.from("allowed_users").select("*").eq("is_used",!0);if(t)e.errors.push("Failed to get used allowed users: ".concat(t.message));else{console.log("Used allowed users:",l);let s=new Set(e.activeUsers.map(e=>e.email.toLowerCase()));if(e.orphanedAllowedUsers=l.filter(e=>!s.has(e.email.toLowerCase())),console.log("Orphaned allowed users:",e.orphanedAllowedUsers),e.orphanedAllowedUsers.length>0)for(let s of e.orphanedAllowedUsers)try{let{error:r}=await n.OQ.from("allowed_users").update({is_used:!1,registered_at:null}).eq("id",s.id);r?e.errors.push("Failed to reset ".concat(s.email,": ").concat(r.message)):(e.resetCount++,console.log("Reset ".concat(s.email)))}catch(r){e.errors.push("Error resetting ".concat(s.email,": ").concat(r.message))}}m(e),e.resetCount>0?h.default.success("✅ Reset ".concat(e.resetCount," orphaned user(s)")):0===e.orphanedAllowedUsers.length&&h.default.success("✅ Databases are already in sync")}catch(s){console.error("Sync error:",s),e.errors.push("Sync error: ".concat(s.message)),m(e),h.default.error("Sync failed: "+s.message)}finally{s(!1)}},u=async e=>{try{console.log("Resetting specific user:",e);let{data:s,error:r}=await n.OQ.from("allowed_users").update({is_used:!1,registered_at:null}).eq("email",e.toLowerCase()).select();if(r)throw r;console.log("Reset user:",s),h.default.success("✅ Reset ".concat(e," - they can now register again")),await x()}catch(e){console.error("Reset error:",e),h.default.error("Failed to reset user: "+e.message)}},g=async()=>{try{let{data:e,error:s}=await n.OQ.from("allowed_users").select("*").eq("email","alenps76@gmail.com").eq("is_used",!1).single();s||!e?h.default.error("❌ Alen still cannot register: ".concat((null==s?void 0:s.message)||"User not found or already used")):h.default.success("✅ Alen can now register successfully!")}catch(e){h.default.error("Test failed: "+e.message)}};return(0,l.jsx)(a.Z,{requireAuth:!0,children:(0,l.jsx)("div",{className:"min-h-screen bg-gray-50",children:(0,l.jsx)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:(0,l.jsxs)("div",{className:"bg-white shadow rounded-lg",children:[(0,l.jsxs)("div",{className:"px-6 py-4 border-b border-gray-200",children:[(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)(d.Z,{className:"h-6 w-6 text-blue-600 mr-3"}),(0,l.jsx)("h1",{className:"text-xl font-semibold text-gray-900",children:"Sync User Databases"})]}),(0,l.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Fix orphaned allowed_users entries when users are deleted"})]}),(0,l.jsxs)("div",{className:"p-6",children:[(0,l.jsx)("div",{className:"mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:(0,l.jsxs)("div",{className:"flex items-start",children:[(0,l.jsx)(i.Z,{className:"h-5 w-5 text-yellow-500 mt-0.5 mr-3"}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"font-medium text-yellow-800 mb-2",children:"Database Sync Issue"}),(0,l.jsxs)("p",{className:"text-sm text-yellow-700",children:["When you delete a user from the User Management page, they're removed from the ",(0,l.jsx)("code",{children:"users"})," table but their entry in the ",(0,l.jsx)("code",{children:"allowed_users"}),' table remains marked as "used". This prevents them from registering again.']})]})]})}),(0,l.jsxs)("div",{className:"mb-6 flex flex-wrap gap-4",children:[(0,l.jsx)("button",{onClick:x,disabled:e,className:"bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center",children:e?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{className:"loading-spinner w-4 h-4 mr-2"}),"Syncing..."]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(c.Z,{className:"h-4 w-4 mr-2"}),"Sync Databases"]})}),(0,l.jsxs)("button",{onClick:()=>u("alenps76@gmail.com"),className:"bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 flex items-center",children:[(0,l.jsx)(o.Z,{className:"h-4 w-4 mr-2"}),"Reset Alen Specifically"]}),(0,l.jsxs)("button",{onClick:g,className:"bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 flex items-center",children:[(0,l.jsx)(o.Z,{className:"h-4 w-4 mr-2"}),"Test Alen Registration"]})]}),r&&(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[(0,l.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:"Sync Results"}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm",children:[(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsx)("p",{className:"text-2xl font-bold text-blue-600",children:r.activeUsers.length}),(0,l.jsx)("p",{className:"text-gray-600",children:"Active Users"})]}),(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsx)("p",{className:"text-2xl font-bold text-yellow-600",children:r.orphanedAllowedUsers.length}),(0,l.jsx)("p",{className:"text-gray-600",children:"Orphaned Entries"})]}),(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsx)("p",{className:"text-2xl font-bold text-green-600",children:r.resetCount}),(0,l.jsx)("p",{className:"text-gray-600",children:"Reset Users"})]})]})]}),r.orphanedAllowedUsers.length>0&&(0,l.jsxs)("div",{children:[(0,l.jsxs)("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:["Orphaned Allowed Users (",r.orphanedAllowedUsers.length,")"]}),(0,l.jsx)("div",{className:"space-y-2",children:r.orphanedAllowedUsers.map(e=>(0,l.jsx)("div",{className:"p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"font-medium",children:e.full_name}),(0,l.jsx)("p",{className:"text-sm text-gray-600",children:e.email}),(0,l.jsx)("p",{className:"text-xs text-gray-400",children:"Marked as used but no active user account"})]}),(0,l.jsx)("button",{onClick:()=>u(e.email),className:"bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700",children:"Reset"})]})},e.id))})]}),r.activeUsers.length>0&&(0,l.jsxs)("div",{children:[(0,l.jsxs)("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:["Active Users (",r.activeUsers.length,")"]}),(0,l.jsx)("div",{className:"max-h-48 overflow-y-auto space-y-1",children:r.activeUsers.map(e=>(0,l.jsx)("div",{className:"p-2 bg-green-50 border border-green-200 rounded text-sm",children:(0,l.jsx)("p",{children:e.email})},e.id))})]}),r.errors.length>0&&(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-lg font-medium text-red-900 mb-3",children:"Errors"}),(0,l.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:(0,l.jsx)("ul",{className:"list-disc list-inside space-y-1 text-sm text-red-700",children:r.errors.map((e,s)=>(0,l.jsx)("li",{children:e},s))})})]})]}),(0,l.jsxs)("div",{className:"mt-8 border-t pt-6",children:[(0,l.jsx)("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"How This Works"}),(0,l.jsxs)("div",{className:"space-y-4 text-sm",children:[(0,l.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[(0,l.jsx)("h3",{className:"font-medium text-blue-800 mb-2",children:"Sync Process:"}),(0,l.jsxs)("ol",{className:"list-decimal list-inside space-y-1 text-blue-700",children:[(0,l.jsx)("li",{children:"Check all active users in the users table"}),(0,l.jsx)("li",{children:'Find allowed_users marked as "used" but with no corresponding active user'}),(0,l.jsx)("li",{children:"Reset these orphaned entries so they can register again"}),(0,l.jsx)("li",{children:"Verify the fix by testing registration"})]})]}),(0,l.jsxs)("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[(0,l.jsx)("h3",{className:"font-medium text-green-800 mb-2",children:"For Alen Specifically:"}),(0,l.jsx)("p",{className:"text-green-700",children:'Since you deleted Alen from User Management, his allowed_users entry is orphaned. Click "Reset Alen Specifically" or "Sync Databases" to fix this and allow him to register again.'})]})]})]})]})]})})})})}}},function(e){e.O(0,[5285,4733,2888,9774,179],function(){return e(e.s=949)}),_N_E=e.O()}]);