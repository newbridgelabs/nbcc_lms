(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8445],{9147:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/upload",function(){return r(9610)}])},7298:function(e,t,r){"use strict";r.d(t,{KO:function(){return a},L$:function(){return c},oN:function(){return o},sN:function(){return n},t7:function(){return l},zy:function(){return i}});var s=r(9495);let n=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;try{let r=await e.arrayBuffer(),n=await s.PDFDocument.load(r),o=n.getPageCount(),l=Math.ceil(o/t),a=[];for(let e=0;e<t;e++){let t=e*l,r=Math.min(t+l-1,o-1);if(t<o){let o=await s.PDFDocument.create();for(let e=t;e<=r;e++){let[t]=await o.copyPages(n,[e]);o.addPage(t)}let l=await o.save();a.push({sectionNumber:e+1,title:"Section ".concat(e+1," (Pages ").concat(t+1,"-").concat(r+1,")"),content:l,pageRange:"".concat(t+1,"-").concat(r+1),totalPages:r-t+1})}}return{sections:a,error:null}}catch(e){return console.error("Error splitting PDF:",e),{sections:null,error:e}}},o=async(e,t)=>{try{console.log("Starting PDF sections upload...");let{data:{session:r}}=await t.auth.getSession();if(!(null==r?void 0:r.access_token))throw Error("No authentication token available");console.log("Session token available, preparing upload...");let s={sections:e.map(t=>({title:t.title,section_number:t.sectionNumber,total_sections:e.length,content:Array.from(new Uint8Array(t.content))}))};console.log("Sending request to upload API...");let n=await fetch("/api/admin/upload-sections",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r.access_token)},body:JSON.stringify(s)});if(console.log("Upload API response status:",n.status),!n.ok){let e="Failed to upload sections";try{let t=await n.json();e=t.error||e,console.error("Upload API error:",t)}catch(r){let t=await n.text();console.error("Upload API returned non-JSON response:",t),e=t.includes("<html>")||t.includes("<!DOCTYPE")?"Server returned HTML instead of JSON. Check server logs for authentication issues.":"Server error: ".concat(n.status," ").concat(n.statusText)}throw Error(e)}let o=await n.json();return console.log("Upload successful:",o),{sections:o.sections,error:null}}catch(e){return console.error("Error uploading sections:",e),{sections:null,error:e}}},l=async e=>{try{if(!e)return{sections:[],error:null};let{data:t,error:r}=await e.from("pdf_sections").select("*").order("section_number");if(r)throw r;return{sections:t,error:null}}catch(e){return{sections:null,error:e}}},a=async(e,t)=>{try{if(console.log("Getting PDF URL for file path:",e),!e)return console.error("No file path provided"),null;let{data:r}=t.storage.from("pdf-sections").getPublicUrl(e);if(console.log("Generated public URL:",null==r?void 0:r.publicUrl),null==r?void 0:r.publicUrl)return console.log("Returning public URL:",r.publicUrl),r.publicUrl;return null}catch(e){return console.error("Error getting PDF URL:",e),null}},i=async(e,t,r)=>{try{if(console.log("Marking section complete:",{userId:e,sectionId:t}),!e||!t)throw Error("User ID and Section ID are required");let r=await fetch("/api/complete-section",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,sectionId:t})}),s=await r.json();if(!r.ok)throw Error(s.error||"Failed to complete section");return console.log("Section marked complete successfully:",s.data),{data:s.data,error:null}}catch(e){return console.error("Error marking section complete:",e),{data:null,error:e}}},c=async(e,t)=>{try{if(!t||!e)return{progress:[],error:null};console.log("Getting user progress for userId:",e);let{data:r,error:s}=await t.from("user_progress").select("\n        *,\n        pdf_sections (\n          id,\n          title,\n          section_number,\n          total_sections\n        )\n      ").eq("user_id",e);if(s)throw console.error("Error fetching user progress:",s),s;console.log("Raw progress data:",r);let n=(null==r?void 0:r.filter(e=>null!==e.pdf_sections))||[];return console.log("Valid progress data:",n),{progress:n,error:null}}catch(e){return console.error("getUserProgress error:",e),{progress:null,error:e}}}},2761:function(e,t,r){"use strict";r.d(t,{Z:function(){return s}});let s=(0,r(3759).Z)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},493:function(e,t,r){"use strict";r.d(t,{Z:function(){return s}});let s=(0,r(3759).Z)("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},3283:function(e,t,r){"use strict";r.d(t,{Z:function(){return s}});let s=(0,r(3759).Z)("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]])},9610:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return f}});var s=r(5893),n=r(7294),o=r(1163),l=r(4733),a=r(1046),i=r(1164),c=r(7298),d=r(2761),u=r(2553),m=r(493),h=r(3283),p=r(6501);function f(){let[e,t]=(0,n.useState)(null),[r,f]=(0,n.useState)(!0),[x,g]=(0,n.useState)(!1),[y,w]=(0,n.useState)(null),[b,N]=(0,n.useState)(5),[j,v]=(0,n.useState)(null),[P,S]=(0,n.useState)([]),k=(0,o.useRouter)();(0,n.useEffect)(()=>{_()},[]);let _=async()=>{let{isAdmin:e,user:r}=await (0,i.jW)(k,t,f);e&&r&&await F()},F=async()=>{try{let{data:e,error:t}=await a.OQ.from("pdf_sections").select("*").order("section_number");if(t)throw t;S(e||[])}catch(e){console.error("Error loading sections:",e)}},U=async()=>{if(!y){p.default.error("Please select a PDF file");return}if(b<1||b>10){p.default.error("Number of sections must be between 1 and 10");return}g(!0),v("Splitting PDF into sections...");try{if(P.length>0&&!window.confirm("This will replace ".concat(P.length," existing sections. Continue?"))){g(!1),v(null);return}let{sections:e,error:t}=await (0,c.sN)(y,b);if(t)throw Error("Failed to split PDF: "+t.message);v("Uploading sections to storage...");let{sections:r,error:s}=await (0,c.oN)(e,a.OQ);if(s)throw Error("Failed to upload sections: "+s.message);v("Upload completed successfully!"),p.default.success("Successfully uploaded ".concat(r.length," sections!")),await F(),w(null),document.getElementById("pdf-file").value="",setTimeout(()=>{v(null)},3e3)}catch(e){console.error("Upload error:",e),p.default.error(e.message||"Failed to upload PDF"),v(null)}finally{g(!1)}},D=async e=>{if(window.confirm("Are you sure you want to delete this section?"))try{let{error:t}=await a.OQ.from("pdf_sections").delete().eq("id",e);if(t)throw t;p.default.success("Section deleted successfully"),await F()}catch(e){console.error("Error deleting section:",e),p.default.error("Failed to delete section")}};return r?(0,s.jsx)(l.Z,{children:(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,s.jsx)("div",{className:"loading-spinner"})})}):(0,s.jsx)(l.Z,{children:(0,s.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,s.jsx)("div",{className:"bg-white shadow",children:(0,s.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("button",{onClick:()=>k.push("/admin"),className:"mr-4 p-2 text-gray-400 hover:text-gray-600",children:(0,s.jsx)(d.Z,{className:"h-5 w-5"})}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-2xl font-bold leading-7 text-gray-900",children:"Upload Study Materials"}),(0,s.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Upload and manage PDF study materials for church membership"})]})]})})}),(0,s.jsxs)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[(0,s.jsxs)("div",{className:"bg-white shadow rounded-lg p-6 mb-8",children:[(0,s.jsx)("h2",{className:"text-lg font-medium text-gray-900 mb-6",children:"Upload New PDF"}),(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select PDF File"}),(0,s.jsx)("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md",children:(0,s.jsxs)("div",{className:"space-y-1 text-center",children:[(0,s.jsx)(u.Z,{className:"mx-auto h-12 w-12 text-gray-400"}),(0,s.jsxs)("div",{className:"flex text-sm text-gray-600",children:[(0,s.jsxs)("label",{htmlFor:"pdf-file",className:"relative cursor-pointer bg-white rounded-md font-medium text-church-primary hover:text-church-secondary focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-church-primary",children:[(0,s.jsx)("span",{children:"Upload a PDF file"}),(0,s.jsx)("input",{id:"pdf-file",name:"pdf-file",type:"file",accept:".pdf",className:"sr-only",onChange:e=>{let t=e.target.files[0];t&&"application/pdf"===t.type?w(t):(p.default.error("Please select a valid PDF file"),e.target.value="")}})]}),(0,s.jsx)("p",{className:"pl-1",children:"or drag and drop"})]}),(0,s.jsx)("p",{className:"text-xs text-gray-500",children:"PDF up to 50MB"})]})}),y&&(0,s.jsxs)("p",{className:"mt-2 text-sm text-gray-600",children:["Selected: ",y.name," (",(y.size/1024/1024).toFixed(2)," MB)"]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Number of Sections"}),(0,s.jsx)("select",{value:b,onChange:e=>N(parseInt(e.target.value)),className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-church-primary focus:border-church-primary",children:[1,2,3,4,5,6,7,8,9,10].map(e=>(0,s.jsxs)("option",{value:e,children:[e," sections"]},e))}),(0,s.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"The PDF will be automatically divided into this many sections"})]}),j&&(0,s.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-4",children:(0,s.jsxs)("div",{className:"flex items-center",children:[x?(0,s.jsx)("div",{className:"loading-spinner w-5 h-5 mr-3"}):(0,s.jsx)(m.Z,{className:"h-5 w-5 text-green-500 mr-3"}),(0,s.jsx)("p",{className:"text-sm text-blue-800",children:j})]})}),(0,s.jsx)("div",{className:"flex justify-end",children:(0,s.jsx)("button",{onClick:U,disabled:!y||x,className:"px-6 py-2 bg-church-primary text-white font-medium rounded-md hover:bg-church-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-church-primary disabled:opacity-50 disabled:cursor-not-allowed",children:x?(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"loading-spinner w-4 h-4 mr-2"}),"Uploading..."]}):(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)(h.Z,{className:"h-4 w-4 mr-2"}),"Upload PDF"]})})})]})]}),P.length>0&&(0,s.jsxs)("div",{className:"bg-white shadow rounded-lg p-6",children:[(0,s.jsxs)("h2",{className:"text-lg font-medium text-gray-900 mb-6",children:["Current Study Sections (",P.length,")"]}),(0,s.jsx)("div",{className:"space-y-4",children:P.map(e=>(0,s.jsxs)("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"font-medium text-gray-900",children:e.title}),(0,s.jsxs)("p",{className:"text-sm text-gray-500",children:["Section ",e.section_number," of ",e.total_sections]})]}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("button",{onClick:()=>k.push("/admin/preview/".concat(e.section_number)),className:"px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200",children:"Preview"}),(0,s.jsx)("button",{onClick:()=>k.push("/admin/content/".concat(e.id)),className:"px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200",children:"Manage Content"}),(0,s.jsx)("button",{onClick:()=>D(e.id),className:"px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200",children:"Delete"})]})]},e.id))})]})]})]})})}}},function(e){e.O(0,[5285,9495,4733,2888,9774,179],function(){return e(e.s=9147)}),_N_E=e.O()}]);