(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5253],{4900:function(e,s,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/fix-registration",function(){return t(6476)}])},3765:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(3759).Z)("AlertCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]])},493:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(3759).Z)("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},9354:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(3759).Z)("Database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]])},5062:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(3759).Z)("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]])},6476:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return h}});var a=t(5893),n=t(7294),r=t(1163),i=t(4733),l=t(1046),c=t(1164),u=t(3765),d=t(5062),o=t(9354),m=t(493),x=t(6501);function h(){let[e,s]=(0,n.useState)(null),[t,h]=(0,n.useState)(!0),[E,T]=(0,n.useState)(!1),[p,N]=(0,n.useState)(null),_=(0,r.useRouter)();(0,n.useEffect)(()=>{f()},[]);let f=async()=>{let{isAdmin:e,user:t}=await (0,c.jW)(_,s,h)},g="\n-- Fix registration access issues\n-- Run this SQL in your Supabase SQL Editor\n\n-- Create function to check if user is allowed to register (bypasses RLS)\nCREATE OR REPLACE FUNCTION public.check_allowed_user(user_email TEXT)\nRETURNS TABLE(id UUID, email TEXT, full_name TEXT, is_used BOOLEAN, invited_by UUID, invitation_sent_at TIMESTAMPTZ, registered_at TIMESTAMPTZ, created_at TIMESTAMPTZ, updated_at TIMESTAMPTZ)\nSECURITY DEFINER\nSET search_path = public\nLANGUAGE plpgsql\nAS $$\nBEGIN\n  RETURN QUERY\n  SELECT \n    au.id,\n    au.email,\n    au.full_name,\n    au.is_used,\n    au.invited_by,\n    au.invitation_sent_at,\n    au.registered_at,\n    au.created_at,\n    au.updated_at\n  FROM public.allowed_users au\n  WHERE au.email = user_email\n  AND au.is_used = false;\nEND;\n$$;\n\n-- Create function to mark allowed user as used (bypasses RLS)\nCREATE OR REPLACE FUNCTION public.mark_allowed_user_used(user_email TEXT)\nRETURNS VOID\nSECURITY DEFINER\nSET search_path = public\nLANGUAGE plpgsql\nAS $$\nBEGIN\n  UPDATE public.allowed_users\n  SET \n    is_used = true,\n    registered_at = NOW()\n  WHERE email = user_email;\nEND;\n$$;\n\n-- Create function to check all allowed users (including used ones) for login error handling\nCREATE OR REPLACE FUNCTION public.check_all_allowed_users(user_email TEXT)\nRETURNS TABLE(id UUID, email TEXT, full_name TEXT, is_used BOOLEAN, invited_by UUID, invitation_sent_at TIMESTAMPTZ, registered_at TIMESTAMPTZ, created_at TIMESTAMPTZ, updated_at TIMESTAMPTZ)\nSECURITY DEFINER\nSET search_path = public\nLANGUAGE plpgsql\nAS $$\nBEGIN\n  RETURN QUERY\n  SELECT \n    au.id,\n    au.email,\n    au.full_name,\n    au.is_used,\n    au.invited_by,\n    au.invitation_sent_at,\n    au.registered_at,\n    au.created_at,\n    au.updated_at\n  FROM public.allowed_users au\n  WHERE au.email = user_email;\nEND;\n$$;\n\n-- Grant execute permissions to anonymous users (for registration)\nGRANT EXECUTE ON FUNCTION public.check_allowed_user(TEXT) TO anon;\nGRANT EXECUTE ON FUNCTION public.mark_allowed_user_used(TEXT) TO anon;\nGRANT EXECUTE ON FUNCTION public.check_all_allowed_users(TEXT) TO anon;\n\n-- Grant execute permissions to authenticated users\nGRANT EXECUTE ON FUNCTION public.check_allowed_user(TEXT) TO authenticated;\nGRANT EXECUTE ON FUNCTION public.mark_allowed_user_used(TEXT) TO authenticated;\nGRANT EXECUTE ON FUNCTION public.check_all_allowed_users(TEXT) TO authenticated;\n",b=async()=>{T(!0),N(null);try{let{data:e,error:s}=await l.OQ.rpc("exec_sql",{sql_query:g});s?(console.error("SQL execution error:",s),N({success:!1,message:"SQL execution failed. Please run the SQL manually in Supabase SQL Editor.",error:s.message}),x.default.error("SQL execution failed. Please run manually in Supabase.")):(N({success:!0,message:"Registration fix applied successfully!",data:e}),x.default.success("Registration fix applied successfully!"))}catch(e){console.error("Error executing SQL:",e),N({success:!1,message:"Failed to execute SQL. Please copy the SQL and run it manually in Supabase SQL Editor.",error:e.message}),x.default.error("Failed to execute SQL")}finally{T(!1)}};return t?(0,a.jsx)(i.Z,{children:(0,a.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"loading-spinner mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-gray-600",children:"Loading admin panel..."})]})})}):(0,a.jsx)(i.Z,{children:(0,a.jsxs)("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[(0,a.jsxs)("div",{className:"mb-8",children:[(0,a.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Fix Registration Issues"}),(0,a.jsx)("p",{className:"mt-2 text-gray-600",children:"This will create database functions to fix the registration access issues."})]}),(0,a.jsxs)("div",{className:"bg-white shadow rounded-lg p-6 mb-8",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Registration Fix SQL"}),(0,a.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-md p-4 mb-6",children:(0,a.jsxs)("div",{className:"flex",children:[(0,a.jsx)(u.Z,{className:"h-5 w-5 text-red-400 mr-2 mt-0.5"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-red-800",children:"Important"}),(0,a.jsx)("p",{className:"text-sm text-red-700 mt-1",children:"This SQL creates database functions to allow user registration. Run this once to fix the registration issues."})]})]})}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex space-x-4",children:[(0,a.jsxs)("button",{onClick:b,disabled:E,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-church-primary hover:bg-church-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-church-primary disabled:opacity-50",children:[E?(0,a.jsx)("div",{className:"loading-spinner w-4 h-4 mr-2"}):(0,a.jsx)(d.Z,{className:"h-4 w-4 mr-2"}),E?"Executing...":"Execute SQL"]}),(0,a.jsxs)("button",{onClick:()=>{navigator.clipboard.writeText(g),x.default.success("SQL copied to clipboard!")},className:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-church-primary",children:[(0,a.jsx)(o.Z,{className:"h-4 w-4 mr-2"}),"Copy SQL"]})]}),p&&(0,a.jsx)("div",{className:"p-4 rounded-md ".concat(p.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:(0,a.jsxs)("div",{className:"flex",children:[p.success?(0,a.jsx)(m.Z,{className:"h-5 w-5 text-green-400 mr-2 mt-0.5"}):(0,a.jsx)(u.Z,{className:"h-5 w-5 text-red-400 mr-2 mt-0.5"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-sm font-medium ".concat(p.success?"text-green-800":"text-red-800"),children:p.success?"Success":"Error"}),(0,a.jsx)("p",{className:"text-sm mt-1 ".concat(p.success?"text-green-700":"text-red-700"),children:p.message}),p.error&&(0,a.jsx)("p",{className:"text-sm text-red-600 mt-2 font-mono",children:p.error})]})]})}),(0,a.jsxs)("div",{className:"bg-gray-50 rounded-md p-4",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-gray-900 mb-2",children:"Manual Instructions"}),(0,a.jsx)("p",{className:"text-sm text-gray-600 mb-2",children:"If automatic execution fails, copy the SQL above and:"}),(0,a.jsxs)("ol",{className:"text-sm text-gray-600 list-decimal list-inside space-y-1",children:[(0,a.jsx)("li",{children:"Go to your Supabase dashboard"}),(0,a.jsx)("li",{children:"Navigate to SQL Editor"}),(0,a.jsx)("li",{children:'Paste the SQL and click "Run"'}),(0,a.jsx)("li",{children:"Refresh this page to test registration"})]})]})]})]}),(0,a.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-4",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-blue-900 mb-2",children:"What this fixes:"}),(0,a.jsxs)("ul",{className:"text-sm text-blue-800 list-disc list-inside space-y-1",children:[(0,a.jsx)("li",{children:"Allows users to register even when not authenticated"}),(0,a.jsx)("li",{children:"Creates secure database functions that bypass RLS for registration"}),(0,a.jsx)("li",{children:"Improves error messages during login attempts"}),(0,a.jsx)("li",{children:"Prevents admin session from showing during user registration"})]})]})]})})}}},function(e){e.O(0,[5285,4733,2888,9774,179],function(){return e(e.s=4900)}),_N_E=e.O()}]);